<mxfile host="app.diagrams.net" modified="2022-03-11T10:13:33.763Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36" etag="sAO35OYkCNOdPfHTmDXK" version="17.0.0" type="github">
  <diagram id="C5RBs43oDa-KdzZeNtuy" name="Page-1">
    <mxGraphModel dx="1550" dy="835" grid="0" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" background="#F4F1DE" math="0" shadow="0">
      <root>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="Uscz21SQ1si1RZ5pgYw--30" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;jumpStyle=none;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.579;entryY=1.001;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#393C56;endArrow=classic;endFill=1;sourcePerimeterSpacing=15;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="zkfFHV4jXpPFQw0GAbJ--0" target="Uscz21SQ1si1RZ5pgYw--4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="316" y="741" />
              <mxPoint x="1021" y="741" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=1;exitDx=0;exitDy=0;labelBackgroundColor=#F4F1DE;strokeColor=#E07A5F;fontColor=#393C56;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="zkfFHV4jXpPFQw0GAbJ--0" target="KjH-scwqGW-Tt5N11Xai-0">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-8" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="zkfFHV4jXpPFQw0GAbJ--0" target="KjH-scwqGW-Tt5N11Xai-5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="zkfFHV4jXpPFQw0GAbJ--0" value="class EventLoop" style="swimlane;fontStyle=2;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="60" width="430" height="550" as="geometry">
            <mxRectangle x="230" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="zkfFHV4jXpPFQw0GAbJ--1" value="  private:&#xa;    // 声明顺序 wakeupFd_ &gt; pwakeupChannel_&#xa;    bool                 looping_;&#xa;    shared_ptr&lt;Epoll&gt;    poller_;&#xa;    int                  wakeupFd_;&#xa;    bool                 quit_;&#xa;    bool                 eventHandling_;&#xa;    mutable MutexLock    mutex_;&#xa;    std::vector&lt;Functor&gt; pendingFunctors_;&#xa;    bool                 callingPendingFunctors_;&#xa;    const pid_t          threadId_;&#xa;    shared_ptr&lt;Channel&gt;  pwakeupChannel_;&#xa;    void wakeup();&#xa;    void handleRead();&#xa;    void doPendingFunctors();&#xa;    void handleConn();" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=none;" parent="zkfFHV4jXpPFQw0GAbJ--0" vertex="1">
          <mxGeometry y="26" width="430" height="237" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--31" value="EventLoop::EventLoop()&#xa;    : looping_(false), poller_(new Epoll()), wakeupFd_(createEventfd()),&#xa;      quit_(false), eventHandling_(false), callingPendingFunctors_(false),&#xa;      threadId_(CurrentThread::tid()),&#xa;      pwakeupChannel_(new Channel(this, wakeupFd_))&#xa;{&#xa;    if (t_loopInThisThread) {&#xa;        // LOG &lt;&lt; &quot;Another EventLoop &quot; &lt;&lt; t_loopInThisThread &lt;&lt; &quot; exists in this&#xa;        // thread &quot; &lt;&lt; threadId_;&#xa;    }&#xa;    else {&#xa;        t_loopInThisThread = this;&#xa;    }&#xa;    // pwakeupChannel_-&gt;setEvents(EPOLLIN | EPOLLET | EPOLLONESHOT);&#xa;    pwakeupChannel_-&gt;setEvents(EPOLLIN | EPOLLET);&#xa;    pwakeupChannel_-&gt;setReadHandler(bind(&amp;EventLoop::handleRead, this));&#xa;    pwakeupChannel_-&gt;setConnHandler(bind(&amp;EventLoop::handleConn, this));&#xa;    poller_-&gt;epoll_add(pwakeupChannel_, 0);&#xa;}" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=#E07A5F;" parent="zkfFHV4jXpPFQw0GAbJ--0" vertex="1">
          <mxGeometry y="263" width="430" height="274" as="geometry" />
        </mxCell>
        <mxCell id="zkfFHV4jXpPFQw0GAbJ--17" value="class Epoll" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="883" y="20" width="476" height="246" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="zkfFHV4jXpPFQw0GAbJ--25" value="  private:&#xa;    static const int          MAXFDS = 100000;&#xa;    int                       epollFd_;&#xa;    std::vector&lt;epoll_event&gt;  events_;&#xa;    std::shared_ptr&lt;Channel&gt;  fd2chan_[MAXFDS];&#xa;    std::shared_ptr&lt;HttpData&gt; fd2http_[MAXFDS];&#xa;    TimerManager              timerManager_;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="zkfFHV4jXpPFQw0GAbJ--17" vertex="1">
          <mxGeometry y="26" width="476" height="110" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--32" value="Epoll::Epoll() : epollFd_(epoll_create1(EPOLL_CLOEXEC)), events_(EVENTSNUM)&#xa;{&#xa;    assert(epollFd_ &gt; 0);&#xa;}" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=#E07A5F;" parent="zkfFHV4jXpPFQw0GAbJ--17" vertex="1">
          <mxGeometry y="136" width="476" height="110" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--2" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="zkfFHV4jXpPFQw0GAbJ--25" target="zkfFHV4jXpPFQw0GAbJ--1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--9" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--3" target="zkfFHV4jXpPFQw0GAbJ--17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--3" value="class Channel" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="909" y="466" width="259" height="282" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--4" value="  private:&#xa;    typedef std::function&lt;void()&gt; CallBack;&#xa;    EventLoop* loop_;&#xa;    int        fd_;&#xa;    __uint32_t events_;&#xa;    __uint32_t revents_;&#xa;    __uint32_t lastEvents_;&#xa;    // 方便找到上层持有该Channel的对象&#xa;    std::weak_ptr&lt;HttpData&gt; holder_;&#xa;  private:&#xa;    int parse_URI();&#xa;    int parse_Headers();&#xa;    int analysisRequest();&#xa;    CallBack readHandler_;&#xa;    CallBack writeHandler_;&#xa;    CallBack errorHandler_;&#xa;    CallBack connHandler_;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--3" vertex="1">
          <mxGeometry y="26" width="259" height="256" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--5" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--4" target="zkfFHV4jXpPFQw0GAbJ--1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="874" y="620" />
              <mxPoint x="874" y="145" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--6" value="class MutexLock : noncopyable" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="570" y="447" width="261" height="116" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--7" value=" private:&#xa;  pthread_mutex_t mutex;&#xa;  // 友元类不受访问权限影响&#xa; private:&#xa;  friend class Condition;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--6" vertex="1">
          <mxGeometry y="26" width="261" height="86" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--8" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--7" target="zkfFHV4jXpPFQw0GAbJ--1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--10" value="class HttpData : public std::enable_shared_from_this&lt;HttpData&gt;" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1641" y="26" width="525" height="392" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--11" value="  private:&#xa;    EventLoop*               loop_;&#xa;    std::shared_ptr&lt;Channel&gt; channel_;&#xa;    int                      fd_;&#xa;    std::string              inBuffer_;&#xa;    std::string              outBuffer_;&#xa;    bool                     error_;&#xa;    ConnectionState          connectionState_;&#xa;    HttpMethod                         method_;&#xa;    HttpVersion                        HTTPVersion_;&#xa;    std::string                        fileName_;&#xa;    std::string                        path_;&#xa;    int                                nowReadPos_;&#xa;    ProcessState                       state_;&#xa;    ParseState                         hState_;&#xa;    bool                               keepAlive_;&#xa;    std::map&lt;std::string, std::string&gt; headers_;&#xa;    std::weak_ptr&lt;TimerNode&gt;           timer_;&#xa;    void          handleRead();&#xa;    void          handleWrite();&#xa;    void          handleConn();&#xa;    void          handleError(int fd, int err_num, std::string short_msg);&#xa;    URIState      parseURI();&#xa;    HeaderState   parseHeaders();&#xa;    AnalysisState analysisRequest();" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--10" vertex="1">
          <mxGeometry y="26" width="525" height="366" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--12" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--11" target="zkfFHV4jXpPFQw0GAbJ--25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--13" value="class TimerManager" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1477" y="504" width="433" height="107" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--14" value="  private:&#xa;    typedef std::shared_ptr&lt;TimerNode&gt; SPTimerNode;&#xa;    std::priority_queue&lt;SPTimerNode, std::deque&lt;SPTimerNode&gt;, TimerCmp&gt;&#xa;        timerNodeQueue;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--13" vertex="1">
          <mxGeometry y="26" width="433" height="79" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--15" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--14" target="zkfFHV4jXpPFQw0GAbJ--25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--20" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;entryX=0.457;entryY=1.025;entryDx=0;entryDy=0;entryPerimeter=0;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--16" target="Uscz21SQ1si1RZ5pgYw--14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1542" y="593.3999633789062" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1705" y="611" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--29" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;jumpStyle=none;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;entryX=0.535;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;fontColor=#393C56;endArrow=classic;endFill=1;sourcePerimeterSpacing=15;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--16" target="Uscz21SQ1si1RZ5pgYw--22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--16" value="class TimerNode" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1488" y="662" width="433" height="107" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--17" value="private:&#xa;    bool                      deleted_;&#xa;    size_t                    expiredTime_;&#xa;    std::shared_ptr&lt;HttpData&gt; SPHttpData;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--16" vertex="1">
          <mxGeometry y="26" width="433" height="79" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--18" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;jumpStyle=none;sourcePerimeterSpacing=14;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--11" target="Uscz21SQ1si1RZ5pgYw--17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--21" value="struct TimerCmp" style="swimlane;fontStyle=0;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="1918" y="542" width="323" height="145" as="geometry">
            <mxRectangle x="550" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--22" value="{&#xa;    bool operator()(std::shared_ptr&lt;TimerNode&gt;&amp; a,&#xa;                    std::shared_ptr&lt;TimerNode&gt;&amp; b) const&#xa;    {&#xa;        return a-&gt;getExpTime() &gt; b-&gt;getExpTime();&#xa;    }&#xa;};" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;" parent="Uscz21SQ1si1RZ5pgYw--21" vertex="1">
          <mxGeometry y="26" width="323" height="119" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--24" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--22" target="Uscz21SQ1si1RZ5pgYw--14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--26" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;jumpStyle=none;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;endArrow=classic;endFill=1;sourcePerimeterSpacing=15;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--17" target="Uscz21SQ1si1RZ5pgYw--11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Uscz21SQ1si1RZ5pgYw--27" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;jumpStyle=none;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontColor=#393C56;endArrow=classic;endFill=1;sourcePerimeterSpacing=15;strokeColor=#E07A5F;fillColor=#F2CC8F;labelBackgroundColor=#F4F1DE;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="Uscz21SQ1si1RZ5pgYw--4" target="Uscz21SQ1si1RZ5pgYw--11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-0" value="class Server" style="swimlane;fontStyle=2;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="46" y="863" width="456" height="489" as="geometry">
            <mxRectangle x="230" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-1" value="  private:&#xa;    EventLoop* loop_;       //事件环&#xa;    int        threadNum_;  //线程数&#xa;    int        port_;       //端口号&#xa;    std::unique_ptr&lt;EventLoopThreadPool&gt; eventLoopThreadPool_;&#xa;    bool                                 started_;&#xa;    std::shared_ptr&lt;Channel&gt;             acceptChannel_;&#xa;    int                                  listenFd_;&#xa;    static const int                     MAXFDS = 100000;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=none;" vertex="1" parent="KjH-scwqGW-Tt5N11Xai-0">
          <mxGeometry y="26" width="456" height="145" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-2" value="Server::Server(EventLoop* loop, int threadNum, int port)&#xa;    : loop_(loop), threadNum_(threadNum), port_(port),&#xa;      eventLoopThreadPool_(new EventLoopThreadPool(loop_, threadNum)),&#xa;      started_(false), acceptChannel_(new Channel(loop_)),&#xa;      listenFd_(socket_bind_listen(port_))&#xa;{&#xa;    acceptChannel_-&gt;setFd(listenFd_);  //莫名其妙为啥不放到构造函数一起操作呢？&#xa;    handle_for_sigpipe();&#xa;    if (setSocketNonBlocking(listenFd_) &lt; 0) {&#xa;        perror(&quot;set socket non block failed&quot;);&#xa;        abort();&#xa;    }&#xa;}" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=#E07A5F;" vertex="1" parent="KjH-scwqGW-Tt5N11Xai-0">
          <mxGeometry y="171" width="456" height="287" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-5" value="class EventLoopThreadPool : noncopyable" style="swimlane;fontStyle=2;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="704" y="871" width="486" height="327" as="geometry">
            <mxRectangle x="230" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-6" value="  private:&#xa;    EventLoop*                                    baseLoop_;&#xa;    bool                                          started_;&#xa;    int                                           numThreads_;&#xa;    int                                           next_;&#xa;    std::vector&lt;std::shared_ptr&lt;EventLoopThread&gt;&gt; threads_;&#xa;    std::vector&lt;EventLoop*&gt;                       loops_;" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=none;" vertex="1" parent="KjH-scwqGW-Tt5N11Xai-5">
          <mxGeometry y="26" width="486" height="145" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-7" value="EventLoopThreadPool::EventLoopThreadPool(EventLoop* baseLoop, int numThreads)&#xa;    : baseLoop_(baseLoop), started_(false), numThreads_(numThreads), next_(0)&#xa;{&#xa;    if (numThreads_ &lt;= 0) {&#xa;        LOG &lt;&lt; &quot;numThreads_ &lt;= 0&quot;;&#xa;        abort();  //中止程序执行，直接从调用的地方跳出。&#xa;    }&#xa;}" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=#E07A5F;" vertex="1" parent="KjH-scwqGW-Tt5N11Xai-5">
          <mxGeometry y="171" width="486" height="136" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-9" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="KjH-scwqGW-Tt5N11Xai-6" target="KjH-scwqGW-Tt5N11Xai-1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-10" value="Util.cpp" style="swimlane;fontStyle=2;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;rounded=0;shadow=0;strokeWidth=1;fillColor=#F2CC8F;strokeColor=#E07A5F;fontColor=#393C56;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="701" y="1285" width="510" height="584" as="geometry">
            <mxRectangle x="230" y="140" width="160" height="26" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-11" value="int socket_bind_listen(int port)&#xa;{&#xa;    // 检查port值，取正确区间范围&#xa;    if (port &lt; 0 || port &gt; 65535)&#xa;        return -1;&#xa;    // 创建socket(IPv4 + TCP)，返回监听描述符&#xa;    int listen_fd = 0;&#xa;    if ((listen_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)&#xa;        return -1;&#xa;    // 消除bind时&quot;Address already in use&quot;错误&#xa;    int optval = 1;&#xa;    if (setsockopt(listen_fd, SOL_SOCKET, SO_REUSEADDR, &amp;optval,&#xa;                   sizeof(optval)) == -1) {&#xa;        close(listen_fd);&#xa;        return -1;&#xa;    }&#xa;    // 设置服务器IP和Port，和监听描述符绑定&#xa;    struct sockaddr_in server_addr;&#xa;    bzero((char*)&amp;server_addr, sizeof(server_addr));&#xa;    server_addr.sin_family      = AF_INET;&#xa;    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);&#xa;    server_addr.sin_port        = htons((unsigned short)port);&#xa;    if (bind(listen_fd, (struct sockaddr*)&amp;server_addr, sizeof(server_addr)) ==&#xa;        -1) {&#xa;        close(listen_fd);&#xa;        return -1;&#xa;    }&#xa;    // 开始监听，最大等待队列长为LISTENQ&#xa;    if (listen(listen_fd, 2048) == -1) {&#xa;        close(listen_fd);&#xa;        return -1;&#xa;    }&#xa;    // 无效监听描述符&#xa;    if (listen_fd == -1) {&#xa;        close(listen_fd);&#xa;        return -1;&#xa;    }&#xa;    return listen_fd;&#xa;}" style="text;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontColor=#393C56;strokeColor=none;" vertex="1" parent="KjH-scwqGW-Tt5N11Xai-10">
          <mxGeometry y="26" width="510" height="558" as="geometry" />
        </mxCell>
        <mxCell id="KjH-scwqGW-Tt5N11Xai-13" style="edgeStyle=orthogonalEdgeStyle;curved=0;rounded=1;sketch=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;fontColor=#393C56;strokeColor=#E07A5F;fillColor=#F2CC8F;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="KjH-scwqGW-Tt5N11Xai-11" target="KjH-scwqGW-Tt5N11Xai-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
